{% extends 'common/index.html'%}
{% include staticfiles%}
{% load common_helpers %}

{% block content %}
<form action="" method="post" id="survey_result_form">
	<h4>Skráningareyðublað</h4>
	<hr />
	<div id="selected_words" class="row alert alert-info">
		<p>{{info|safe}}</p>
	</div>
	<div class='md' id="grading_template">{{grading_template|safe}}</div>
	<div id="selected_words" class="row"></div>
	<hr />
	{% if input_fields %}
	<h4>Innsláttarsvæði</h4>
	<div id="input_fields">
		{% for field in input_fields %}
			<div class="row">
				<div class="col-md-1">
					{{ field.label }}
				</div>
				<div class="col-md-3">
					<input type="text" name="{{ field.name }}" id="{{ field.name }}" />
				</div>
				<div class="col-md-4 alert-info">
					{{ field.description }}
				</div>
			</div>
		{% endfor %}
	</div>
	{% endif %}
	{% csrf_token %}
	{{ form.as_p }}
	<input type="submit" class="btn btn-success" value="Vista" />
</form>
{% endblock %}

{% block script %}
	<script type='text/javascript'>
		var data_results = {{data_result|safe}};
		var update = [];
		if(data_results){
			//updating, prepare to highlight data
			try {
				var click_values = JSON.parse(data_results['click_values']);
				for(i in click_values){
					//data_results = {
						//'click_values': ['number,value', 'number,value', ...],
						//'input_values': {
							//'input_field_1': 'value',
							//'input_field_2': 'value',
						//}
					//}
					update.push(click_values[i].split(',')[0]);
				}
				var input_values = data_results['input_values'];
				var input_keys = Object.keys(data_results['input_values']);
			}
			catch(err) {}
		}

		// input
		// val = string
		// output = string where each word has been wrapped with span count=word number
		function wrap_text( val ){
			var words = val.match(/([^\x00-\x7F]|\w)+/g);
			results = "";
			for(i in words){
				var replaced = val.replace(words[i], "<span count='"+i+"'>"+words[i]+"</span>"); //get replaced text
				results += replaced.split('</span>')[0]+'</span>'; //add replaced text to results
				val = replaced.split('</span>')[1]; //continue working on val
			}
			results += val; //add the rest of val
			return results;
		}

		// update click_input form
		try {
			//wrap each word in span count
			var text_container = $("#grading_template");
			text_container.html(wrap_text(text_container.html()));
			//highlight words from update array
			for(i in update) {
				$('span[count='+update[i]+']').toggleClass('selected');
			}
		}
		catch(err) {
			console.log(err);
		}

		// update input_fields
		try {
			for(i in input_keys)
			{
				$("#"+input_keys[i]).val(input_values[input_keys[i]]);
			}
		}
		catch(err) {
			console.log(err);
		}


		$( ".md" ).each(function( index ) {
			$( this ).html(marked( $( this ).html() ));
		});
		$('span[count]').on('click',function(event){
			//append removable div to grading_template
			var selected_text = $(this).toggleClass('selected');
		});

		$("#survey_result_form").on('submit', function(event){
			//event.preventDefault();
			var selected_words = $("span.selected");
			selected_words.each(function(i){
				$("#survey_result_form").append($("<input type='hidden' />").attr({
					name:'data_results[]',
					value: [$(selected_words[i]).attr('count'), $(selected_words[i]).text()]
				}));
			});

		});
	</script>
	{% endblock %}