{% extends 'common/index.html'%}
{% include staticfiles%}
{% load common_helpers %}

{% block content %}
<form action="" method="post" id="survey_result_form">
	<div id="selected_words" class="row alert alert-info">
		<p>Smelltu á orð í textanum fyrir neðan sem voru rangt lesin.</p>
		<p>Smelltu á síðasta orðið sem nemandi las.</p>
		<p>Ef rangt orð er valið, smelltu aftur á orðið til þess að fjarlægja valið</p>
	</div>
	<div class='md' id="grading_template">{{grading_template|safe}}</div>
	<div id="selected_words" class="row"></div>
	{% csrf_token %}
	{{ form.as_p }}
	<input type="submit" value="Save" />
</form>
{% endblock %}

{% block script %}
	<script type='text/javascript'>
		var data_results = {{data_result|safe}};

		var update = [];
		if(data_results){
			//updating, prepare to highlight data
			for(i in data_results){
				//data_results = ['number,value', 'number,value', ...]
				update.push(data_results[i].split(',')[0]);
			}
		}

		// input
		// val = string
		// output = string where each word has been wrapped with span count=word number
		function wrap_text( val ){
			var words = val.match(/[\w]+/g);
			results = "";
			for(i in words){
				var replaced = val.replace(words[i], "<span count='"+i+"'>"+words[i]+"</span>"); //get replaced text
				results += replaced.split('</span>')[0]+'</span>'; //add replaced text to results
				val = replaced.split('</span>')[1]; //continue working on val
			}
			results += val; //add the rest of val
			return results;
		}

		try {
			//wrap each word in span count
			var text_container = $("#grading_template");
			text_container.html(wrap_text(text_container.html()));
			//highlight words from update array
			for(i in update) {
				$('span[count='+update[i]+']').toggleClass('selected');
			}
		}
		catch(err) {
			console.log(err);
		}

		$( ".md" ).each(function( index ) {
			$( this ).html(marked( $( this ).html() ));
		});
		$('span[count]').on('click',function(event){
			//append removable div to grading_template
			var selected_text = $(this).toggleClass('selected');
			console.log(event.which);
		});

		$("#survey_result_form").on('submit', function(event){
			//event.preventDefault();
			var selected_words = $("span.selected");
			selected_words.each(function(i){
				$("#survey_result_form").append($("<input type='hidden' />").attr({
					name:'data_results[]',
					value: [$(selected_words[i]).attr('count'), $(selected_words[i]).text()]
				}));
			});
		});
	</script>
	{% endblock %}