{% extends 'common/index.html'%}

{% block content %}
<h3>Prófadæma svör</h3>
<div class="row">
	<a href="{% url 'schools:example_survey_answer_admin_import' %}" class="btn btn-default">
		<span class="glyphicon glyphicon-plus"></span>&nbsp;Bæta við svörum
	</a>
</div>
<div class="row" id="progressbars">
</div>

{% if exam_codes %}
<div>
	<table class="table table-hover table-striped" id="example_survey_answer_exam_code_list">
		<thead>
			<th>Prófkóði</th>
			<th>Aðgerðir</th>
		</thead>
		<tbody>
			{% for exam_code in exam_codes %}
				<tr>
					<td><a href="{% url 'schools:example_survey_answer_admin_listing_by_code' exam_code %}">{{exam_code}}</a></td>
					<td><a href="{% url 'schools:example_survey_answer_admin_delete_by_code' exam_code %}"><span class="glyphicon glyphicon-trash"></span></a></td>
				</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
{% endif %}
{% if answers %}
<div>
	<table class="table table-hover table-striped" id="example_survey_answer_list">
		<thead>
			<tr>
				<th>Kennitala</th>
				<th>Flýtikóði</th>
				<th>Próf</th>
				<th>Dags</th>
				<th>Svar</th>
				<th>Aðgerðir</th>
			</tr>
		</thead>
		<tbody>
			{% for answer in answers %}
			<tr>
				<td>{{answer.student.ssn}}</td>
				<td>{{answer.question.quickcode}}</td>
				<td>
				{% if answer.groupsurvey %}
					{{answer.groupsurvey.survey.identifier}}
				{% else %}
					{{ answer.exam_code }}
				{% endif %}
				</td>
				<td>{{answer.date}}</td>
				<td>
				{% if answer.answer %}
					<span class="glyphicon glyphicon-ok" style="color:green"></span>&nbsp;
				{% else %}
					<span class="glyphicon glyphicon-remove" style="color:red"></span>&nbsp;
				{% endif %}
				</td>
				<td>
					<a href="{% url 'schools:example_survey_answer_admin_detail' answer.id %}">
						<span class="glyphicon glyphicon-eye-open"></span>
					</a>
					<a href="{% url 'schools:example_survey_answer_admin_delete' answer.id %}">
						<span class="glyphicon glyphicon-trash"></span>
					</a>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
	<div class="pagination">
    <span class="step-links">
        {% if answers.has_previous %}
            <a href="?page={{ answers.previous_page_number }}"><span class="glyphicon glyphicon-chevron-left"></span>&nbsp;previous</a>
        {% endif %}

        <span class="current">
            Page {{ answers.number }} of {{ answers.paginator.num_pages }}.
        </span>

        {% if answers.has_next %}
            <a href="?page={{ answers.next_page_number }}">next&nbsp;<span class="glyphicon glyphicon-chevron-right"></span></a>
        {% endif %}
    </span>
	</div>
</div>
{% endif %}
{% endblock %}

{% block script %}

<script type="text/javascript">
function abort_task(job_id) {
	if (confirm("Ertu viss?")) {
		$.post("{% url 'schools:api_task_monitor' %}", {'abort': true, 'job_id': job_id, 'csrfmiddlewaretoken': '{{ csrf_token }}'})
		$("#result-row-" + job_id).remove();
	}
}

$(document).ready(function(){
	var jobpump = setInterval(function checkjobs() {
		$.get("{% url 'schools:api_task_monitor' %}?job_name=save_example_survey_answers", function(data){
			console.log(data);
			if (typeof(data) == "object") {
				for (i = 0; i < data.length; i++) {
					job_data = data[i];
					if (typeof(job_data) == "object") {
						if ("id" in job_data ) {
							job_id = job_data["id"];
							rowselector = "result-row-" + job_id;
							identifierselector = "identifier-" + job_id;
							jobprogressselector = "job-progress-" + job_id;

							resulttextselector = "result-text-" + job_id;
							resulttextouterselector = "outer-" + resulttextselector;

							if ($("#" + rowselector).length == 0) {
								// Add a line for this job
								$("#progressbars").append('<div class="row" id="' + rowselector + '"></div>');
								$("#" + rowselector).css("display", "none");
								$("#" + rowselector).append('<div class="col-md-4" id="' + resulttextouterselector + '">Innlestur í gangi <span id="' + resulttextselector + '"></span></div>');
								$("#" + rowselector).append('<div class="col-md-5"><div class="progress"><div id="' + jobprogressselector + '"></div></div></div>');
								$("#" + jobprogressselector).addClass("progress-bar progress-bar-striped active");
								$("#" + jobprogressselector).attr("aria-valuenow", "0");
								$("#" + jobprogressselector).attr("aria-valuemin", "0");
								$("#" + jobprogressselector).attr("aria-valuemax", "100");
								$("#" + jobprogressselector).css("width", "0%");
								$("#" + rowselector).append('<div class="col-md-2" id="' + identifierselector + '"></div>');
								$("#" + rowselector).append('<div class="col-md-1"><a title="Stöðva innlestur" href="javascript:abort_task(\'' + job_id + '\');" class="btn btn-xs"><span class="glyphicon glyphicon-remove-circle"></span></a></div>')
							}

							if ("state" in job_data) {
								// Populate the line we added
								state = job_data["state"];
								if (typeof(state) == "object") {
									$("#" + identifierselector).html(state["exam_code"])
									$("#" + resulttextselector).html("(" + state["current"] + " af " + state["total"] + ")");
									pct = ((state["current"] / state["total"]) * 100).toFixed(1);
									$("#" + jobprogressselector).css("width", pct + "%");
									$("#" + jobprogressselector).html(pct + "%");

								} else if (typeof(state) == "string") {
									if (state == "FAILURE") {
										$("#" + resulttextouterselector).html('<p class="danger">Innlestur mistókst!</p>');
										$("#" + jobprogressselector).removeClass("active");
									} else if (state == "SUCCESS") {
										$("#" + resulttextouterselector).html('<p>Innlestur tókst!</p>');
										$("#" + jobprogressselector).css("width", "100%");
										$("#" + jobprogressselector).html("100%");
										$("#" + jobprogressselector).removeClass("active");
									}
								}
								$("#" + rowselector).show();
							}
						}
					}
				} 
			}
    	});
    	return checkjobs;
	}, 3000);
});
</script>

{% endblock %}